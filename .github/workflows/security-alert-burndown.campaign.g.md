---
name: "Security Alert Burndown"
description: "Orchestrator workflow for campaign 'security-alert-burndown'"
on:
  roles:
    - "admin"
    - "maintainer"
    - "write"
  schedule:
    - cron: "0 18 * * *"
  workflow_dispatch:
concurrency:
  group: "campaign-security-alert-burndown-orchestrator-${{ github.ref }}"
  cancel-in-progress: false
engine: claude
safe-outputs:
  add-comment:
    max: 3
  create-issue:
    max: 1
  create-project-status-update:
    max: 1
    project: "https://github.com/orgs/githubnext/projects/122"
  update-project:
    max: 10
    project: "https://github.com/orgs/githubnext/projects/122"
runs-on: ubuntu-latest
tools:
  bash:
  - "*"
  edit: null
  github:
    toolsets:
    - default
    - actions
    - code_security
  repo-memory:
  - branch-name: memory/campaigns
    file-glob:
    - security-alert-burndown/**
    id: campaigns
steps:
- name: Create workspace directory
  run: mkdir -p ./.gh-aw
- env:
    GH_AW_CAMPAIGN_ID: security-alert-burndown
    GH_AW_CURSOR_PATH: /tmp/gh-aw/repo-memory/campaigns/security-alert-burndown/cursor.json
    GH_AW_DISCOVERY_REPOS: githubnext/gh-aw
    GH_AW_MAX_DISCOVERY_ITEMS: "50"
    GH_AW_MAX_DISCOVERY_PAGES: "3"
    GH_AW_PROJECT_URL: https://github.com/orgs/githubnext/projects/122
    GH_AW_TRACKER_LABEL: campaign:security-alert-burndown
    GH_AW_WORKFLOWS: code-scanning-fixer,security-fix-pr,security-review
  id: discovery
  name: Precompute campaign discovery
  uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
  with:
    github-token: ${{ secrets.GH_AW_GITHUB_MCP_SERVER_TOKEN || secrets.GH_AW_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}
    script: |
      
      const { setupGlobals } = require('/opt/gh-aw/actions/setup_globals.cjs');
      setupGlobals(core, github, context, exec, io);
      const { main } = require('/opt/gh-aw/actions/campaign_discovery.cjs');
      await main();
---

<!-- This file was automatically generated by gh-aw. DO NOT EDIT. -->
<!-- Source: .github/workflows/security-alert-burndown.campaign.md -->

# Campaign Orchestrator

This workflow orchestrates the 'Security Alert Burndown' campaign.

- Objective: Systematically burn down the code security alerts backlog, prioritizing file write vulnerabilities
- KPIs:
  - High-Severity Alerts Fixed (primary): baseline 0 → target 20 over 30 days alerts
  - File Write Vulnerabilities Fixed (supporting): baseline 0 → target 10 over 30 days alerts
- Associated workflows: code-scanning-fixer, security-fix-pr, security-review
- Memory paths: memory/campaigns/security-alert-burndown/**
- Metrics glob: `memory/campaigns/security-alert-burndown/metrics/*.json`
- Cursor glob: `memory/campaigns/security-alert-burndown/cursor.json`
- Project URL: https://github.com/orgs/githubnext/projects/122
- Governance: max new items per run: 3
- Governance: max discovery items per run: 50
- Governance: max discovery pages per run: 3
- Governance: opt-out labels: no-campaign, no-bot, wontfix
- Governance: max project updates per run: 10
- Governance: max comments per run: 3

---
# ORCHESTRATOR INSTRUCTIONS
---
# Orchestrator Instructions

This orchestrator coordinates a single campaign by discovering worker outputs, making deterministic decisions,
and synchronizing campaign state into a GitHub Project board.

**Scope:** orchestration only (discovery, planning, pacing, reporting).  
**Write authority:** all project write semantics are governed by **Project Update Instructions** and MUST be followed.

---

## Traffic and Rate Limits (Required)

- Minimize API calls; avoid full rescans when possible.
- Prefer incremental discovery with deterministic ordering (e.g., by `updatedAt`, tie-break by ID).
- Enforce strict pagination budgets; if a query requires many pages, stop early and continue next run.
- Use a durable cursor/checkpoint so the next run continues without rescanning.
- On throttling (HTTP 429 / rate-limit 403), do not retry aggressively; back off and end the run after reporting what remains.


**Cursor file (repo-memory)**: `memory/campaigns/security-alert-burndown/cursor.json`  
**File system path**: `/tmp/gh-aw/repo-memory/campaigns/security-alert-burndown/cursor.json`  
- If it exists: read first and continue from its boundary.  
- If it does not exist: create it by end of run.  
- Always write the updated cursor back to the same path.



**Metrics snapshots (repo-memory)**: `memory/campaigns/security-alert-burndown/metrics/*.json`  
**File system path**: `/tmp/gh-aw/repo-memory/campaigns/security-alert-burndown/metrics/*.json`  
- Persist one append-only JSON metrics snapshot per run (new file per run; do not rewrite history).
- Use UTC date (`YYYY-MM-DD`) in the filename (example: `metrics/2025-12-22.json`).
- Each snapshot MUST include ALL required fields (even if zero):
  - `campaign_id` (string): The campaign identifier
  - `date` (string): UTC date in YYYY-MM-DD format
  - `tasks_total` (number): Total number of tasks (>= 0, even if 0)
  - `tasks_completed` (number): Completed task count (>= 0, even if 0)
- Optional fields (include only if available): `tasks_in_progress`, `tasks_blocked`, `velocity_per_day`, `estimated_completion`
- Example minimum valid snapshot:
  ```json
  {
    "campaign_id": "security-alert-burndown",
    "date": "2025-12-22",
    "tasks_total": 0,
    "tasks_completed": 0
  }
  ```



**Read budget**: max discovery items per run: 50


**Read budget**: max discovery pages per run: 3


**Write budget**: max project updates per run: 10


**Write budget**: max project comments per run: 3


---

## Core Principles

1. Workers are immutable and campaign-agnostic
2. The GitHub Project board is the authoritative campaign state
3. Correlation is explicit (tracker-id)
4. Reads and writes are separate steps (never interleave)
5. Idempotent operation is mandatory (safe to re-run)
6. Only predefined project fields may be updated
7. **Project Update Instructions take precedence for all project writes**

---

## Execution Steps (Required Order)

### Step 0 — Epic Issue Initialization [FIRST RUN ONLY]

**Campaign Epic Issue Requirements:**
- Each project board MUST have exactly ONE Epic issue representing the campaign
- The Epic serves as the parent for all campaign work issues
- The Epic is narrative-only and tracks overall campaign progress

**On every run, before other steps:**

1) **Check for existing Epic issue** by searching the repository for:
   - An open issue with label `epic` or `type:epic`
   - Body text containing: `campaign_id: security-alert-burndown`

2) **If no Epic issue exists**, create it using `create-issue`:
   ```yaml
   create-issue:
     title: "Security Alert Burndown"
     body: |
       ## Campaign Overview
       
       **Objective**: Systematically burn down the code security alerts backlog, prioritizing file write vulnerabilities
       
       This Epic issue tracks the overall progress of the campaign. All work items are sub-issues of this Epic.
       
       **Campaign Details:**
       - Campaign ID: `security-alert-burndown`
       - Project Board: https://github.com/orgs/githubnext/projects/122
       - Worker Workflows: `code-scanning-fixer`, `security-fix-pr`, `security-review`
       
       ---
       `campaign_id: security-alert-burndown`
     labels:
       - epic
       - type:epic
   ```

3) **After creating the Epic** (or if Epic exists but not on board), add it to the project board:
   ```yaml
   update-project:
     project: "https://github.com/orgs/githubnext/projects/122"
     campaign_id: "security-alert-burndown"
     content_type: "issue"
     content_number: <EPIC_ISSUE_NUMBER>
     fields:
       status: "In Progress"
       campaign_id: "security-alert-burndown"
       worker_workflow: "unknown"
       repository: "<OWNER/REPO>"
       priority: "High"
       size: "Large"
       start_date: "<EPIC_CREATED_DATE_YYYY-MM-DD>"
       end_date: "<TODAY_YYYY-MM-DD>"
   ```

4) **Record the Epic issue number** in repo-memory for reference (e.g., in cursor file or metadata).

**Note:** This step typically runs only on the first orchestrator execution. On subsequent runs, verify the Epic exists and is on the board, but do not recreate it.

---

### Step 1 — Read State (Discovery) [NO WRITES]

**IMPORTANT**: Discovery has been precomputed. Read the discovery manifest instead of performing GitHub-wide searches.

1) Read the precomputed discovery manifest: `./.gh-aw/campaign.discovery.json`
   - This manifest contains all discovered worker outputs with normalized metadata
   - Schema version: v1
   - Fields: campaign_id, generated_at, discovery (total_items, cursor info), summary (counts), items (array of normalized items)

2) Read current GitHub Project board state (items + required fields).

3) Parse discovered items from the manifest:
   - Each item has: url, content_type (issue/pull_request/discussion), number, repo, created_at, updated_at, state
   - Closed items have: closed_at (for issues) or merged_at (for PRs)
   - Items are pre-sorted by updated_at for deterministic processing

4) Check the manifest summary for work counts:
   - `needs_add_count`: Number of items that need to be added to the project
   - `needs_update_count`: Number of items that need status updates
   - If both are 0, you may skip to reporting step

5) Discovery cursor is maintained automatically in repo-memory; do not modify it manually.

### Step 2 — Make Decisions (Planning) [NO WRITES]

5) Determine desired `status` strictly from explicit GitHub state:
- Open → `Todo` (or `In Progress` only if explicitly indicated elsewhere)
- Closed (issue/discussion) → `Done`
- Merged (PR) → `Done`

**Why use explicit GitHub state?** - GitHub is the source of truth for work status. Inferring status from other signals (labels, comments) would be unreliable and could cause incorrect tracking.

6) Calculate required date fields for each item (per Project Update Instructions):
- `start_date`: format `created_at` as `YYYY-MM-DD`
- `end_date`:
  - if closed/merged → format `closed_at`/`merged_at` as `YYYY-MM-DD`
  - if open → **today's date** formatted `YYYY-MM-DD` (required for roadmap view)

**Why use today for open items?** - GitHub Projects requires end_date for roadmap views. Using today's date shows the item is actively tracked and updates automatically each run until completion.

7) Do NOT implement idempotency by comparing against the board. You may compare for reporting only.

**Why no comparison for idempotency?** - The safe-output system handles deduplication. Comparing would add complexity and potential race conditions. Trust the infrastructure.

8) Apply write budget:
- If `MaxProjectUpdatesPerRun > 0`, select at most that many items this run using deterministic order
  (e.g., oldest `updated_at` first; tie-break by ID/number).
- Defer remaining items to next run via cursor.

**Why use deterministic order?** - Ensures predictable behavior and prevents starvation. Oldest items are processed first, ensuring fair treatment of all work items. The cursor saves progress for next run.

### Step 3 — Write State (Execution) [WRITES ONLY]

9) For each selected item, send an `update-project` request.
- Do NOT interleave reads.
- Do NOT pre-check whether the item is on the board.
- **All write semantics MUST follow Project Update Instructions**, including:
  - first add → full required fields (status, campaign_id, worker_workflow, repo, priority, size, start_date, end_date)
  - existing item → status-only update unless explicit backfill is required

10) Record per-item outcome: success/failure + error details.

### Step 4 — Report & Status Update

11) **REQUIRED: Create a project status update summarizing this run**

Every campaign run MUST create a status update using `create-project-status-update` safe output. This is the primary communication mechanism for conveying campaign progress to stakeholders.

**Required Sections:**

- **Most Important Findings**: Highlight the 2-3 most critical discoveries, insights, or blockers from this run
- **What Was Learned**: Document key learnings, patterns observed, or insights gained during this run
- **KPI Trends**: Report progress on EACH campaign KPI (High-Severity Alerts Fixed, File Write Vulnerabilities Fixed) with baseline → current → target format, including direction and velocity
- **Campaign Summary**: Tasks completed, in progress, blocked, and overall completion percentage
- **Next Steps**: Clear action items and priorities for the next run

**Configuration:**
- Set appropriate status: ON_TRACK, AT_RISK, OFF_TRACK, or COMPLETE
- Use today's date for start_date and target_date (or appropriate future date for target)
- Body must be comprehensive yet concise (target: 200-400 words)


**Campaign KPIs to Report:**

- **High-Severity Alerts Fixed** (primary): baseline 0 alerts → target 20 alerts over 30 days

- **File Write Vulnerabilities Fixed** (supporting): baseline 0 alerts → target 10 alerts over 30 days



Example status update:
```yaml
create-project-status-update:
  project: "https://github.com/orgs/githubnext/projects/122"
  status: "ON_TRACK"
  start_date: "2026-01-06"
  target_date: "2026-01-31"
  body: |
    ## Campaign Run Summary

    **Discovered:** 25 items (15 issues, 10 PRs)
    **Processed:** 10 items added to project, 5 updated
    **Completion:** 60% (30/50 total tasks)

    ## Most Important Findings

    1. **Critical accessibility gaps identified**: 3 high-severity accessibility issues discovered in mobile navigation, requiring immediate attention
    2. **Documentation coverage acceleration**: Achieved 5% improvement in one week (best velocity so far)
    3. **Worker efficiency improving**: daily-doc-updater now processing 40% more items per run

    ## What Was Learned

    - Multi-device testing reveals issues that desktop-only testing misses - should be prioritized
    - Documentation updates tied to code changes have higher accuracy and completeness
    - Users report fewer issues when examples include error handling patterns

    ## KPI Trends

    **Documentation Coverage** (Primary KPI):
    - Baseline: 85% → Current: 88% → Target: 95%
    - Direction: ↑ Increasing (+3% this week, +1% velocity/week)
    - Status: ON TRACK - At current velocity, will reach 95% in 7 weeks

    **Accessibility Score** (Supporting KPI):
    - Baseline: 90% → Current: 91% → Target: 98%
    - Direction: ↑ Increasing (+1% this month)
    - Status: AT RISK - Slower progress than expected, may need dedicated focus

    **User-Reported Issues** (Supporting KPI):
    - Baseline: 15/month → Current: 12/month → Target: 5/month
    - Direction: ↓ Decreasing (-3 this month, -20% velocity)
    - Status: ON TRACK - Trending toward target

    ## Next Steps

    1. Address 3 critical accessibility issues identified this run (high priority)
    2. Continue processing remaining 15 discovered items
    3. Focus on accessibility improvements to accelerate supporting KPI
    4. Maintain current documentation coverage velocity
```

12) Report:
- counts discovered (by type)
- counts processed this run (by action: add/status_update/backfill/noop/failed)
- counts deferred due to budgets
- failures (with reasons)
- completion state (work items only)
- cursor advanced / remaining backlog estimate

---

## Authority

If any instruction in this file conflicts with **Project Update Instructions**, the Project Update Instructions win for all project writes.
---
# PROJECT UPDATE INSTRUCTIONS (AUTHORITATIVE FOR WRITES)
---
# Project Update Instructions (Authoritative Write Contract)

## Project Board Integration

This file defines the ONLY allowed rules for writing to the GitHub Project board.
If any other instructions conflict with this file, THIS FILE TAKES PRECEDENCE for all project writes.

---

## 0) Hard Requirements (Do Not Deviate)

- Writes MUST use only the `update-project` safe-output.
- All writes MUST target exactly:
  - **Project URL**: `https://github.com/orgs/githubnext/projects/122`
- Every item MUST include:
  - `campaign_id: "security-alert-burndown"`

## Campaign ID

All campaign tracking MUST key off `campaign_id: "security-alert-burndown"`.

---

## 1) Required Project Fields (Must Already Exist)

| Field | Type | Allowed / Notes |
|---|---|---|
| `status` | single-select | `Todo` / `In Progress` / `Review required` / `Blocked` / `Done` |
| `campaign_id` | text | Must equal `security-alert-burndown` |
| `worker_workflow` | text | workflow ID or `"unknown"` |
| `repository` | text | `owner/repo` |
| `priority` | single-select | `High` / `Medium` / `Low` |
| `size` | single-select | `Small` / `Medium` / `Large` |
| `start_date` | date | `YYYY-MM-DD` |
| `end_date` | date | `YYYY-MM-DD` |

Field names are case-sensitive.

---

## 2) Content Identification (Mandatory)

Use **content number** (integer), never the URL as an identifier.

- Issue URL: `.../issues/123` → `content_type: "issue"`, `content_number: 123`
- PR URL: `.../pull/456` → `content_type: "pull_request"`, `content_number: 456`

---

## 3) Deterministic Field Rules (No Inference)

These rules apply to any time you write fields:

- `campaign_id`: always `security-alert-burndown`
- `worker_workflow`: workflow ID if known, else `"unknown"`
- `repository`: extract `owner/repo` from the issue/PR URL
- `priority`: default `Medium` unless explicitly known
- `size`: default `Medium` unless explicitly known
- `start_date`: issue/PR `created_at` formatted `YYYY-MM-DD`
- `end_date`:
  - if closed/merged → `closed_at` / `merged_at` formatted `YYYY-MM-DD`
  - if open → **today’s date** formatted `YYYY-MM-DD` (**required for roadmap view; do not leave blank**)

For open items, `end_date` is a UI-required placeholder and does NOT represent actual completion.

---

## 4) Read-Write Separation (Prevents Read/Write Mixing)

1. **READ STEP (no writes)** — validate existence and gather metadata
2. **WRITE STEP (writes only)** — execute `update-project`

Never interleave reads and writes.

---

## 5) Adding an Issue or PR (First Write)

### Adding New Issues

When first adding an item to the project, you MUST write ALL required fields.

```yaml
update-project:
  project: "https://github.com/orgs/githubnext/projects/122"
  campaign_id: "security-alert-burndown"
  content_type: "issue"              # or "pull_request"
  content_number: 123
  fields:
    status: "Todo"                   # "Done" if already closed/merged
    campaign_id: "security-alert-burndown"
    worker_workflow: "unknown"
    repository: "owner/repo"
    priority: "Medium"
    size: "Medium"
    start_date: "2025-12-15"
    end_date: "2026-01-03"
```

---

## 6) Updating an Existing Item (Minimal Writes)

### Updating Existing Items

Preferred behavior is minimal, idempotent writes:

- If item exists and `status` is unchanged → **No-op**
- If item exists and `status` differs → **Update `status` only**
- If any required field is missing/empty/invalid → **One-time full backfill** (repair only)

### Status-only Update (Default)

```yaml
update-project:
  project: "https://github.com/orgs/githubnext/projects/122"
  campaign_id: "security-alert-burndown"
  content_type: "issue"              # or "pull_request"
  content_number: 123
  fields:
    status: "Done"
```

### Full Backfill (Repair Only)

```yaml
update-project:
  project: "https://github.com/orgs/githubnext/projects/122"
  campaign_id: "security-alert-burndown"
  content_type: "issue"              # or "pull_request"
  content_number: 123
  fields:
    status: "Done"
    campaign_id: "security-alert-burndown"
    worker_workflow: "WORKFLOW_ID"
    repository: "owner/repo"
    priority: "Medium"
    size: "Medium"
    start_date: "2025-12-15"
    end_date: "2026-01-02"
```

---

## 7) Idempotency Rules

- Matching status already set → **No-op**
- Different status → **Status-only update**
- Invalid/deleted/inaccessible URL → **Record failure and continue**

## Write Operation Rules

All writes MUST conform to this file and use `update-project` only.

---

## 8) Logging + Failure Handling (Mandatory)

For every attempted item, record:

- `content_type`, `content_number`, `repository`
- action taken: `noop | add | status_update | backfill | failed`
- error details if failed

Failures must not stop processing remaining items.

---

## 9) Worker Workflow Policy

- Workers are campaign-agnostic.
- Orchestrator populates `worker_workflow`.
- If `worker_workflow` cannot be determined, it MUST remain `"unknown"` unless explicitly reclassified by the orchestrator.

---

## 10) Parent / Sub-Issue Rules (Campaign Hierarchy)

- Each project board MUST have exactly **one Epic issue** representing the campaign.
- The Epic issue MUST:
  - Be added to the project board
  - Use the same `campaign_id`
  - Use `worker_workflow: "unknown"`

- All campaign work issues (non-epic) MUST be created as **sub-issues of the Epic**.
- Issues MUST NOT be re-parented based on worker assignment.

- Pull requests cannot be sub-issues:
  - PRs MUST reference their related issue via standard GitHub linking (e.g. “Closes #123”).

- Worker grouping MUST be done via the `worker_workflow` project field, not via parent issues.

- The Epic issue is narrative only.
- The project board is the sole authoritative source of campaign state.

---

## Appendix — Machine Check Checklist (Optional)

This checklist is designed to validate outputs before executing project writes.

### A) Output Structure Checks

- [ ] All writes use `update-project:` blocks (no other write mechanism).
- [ ] Each `update-project` block includes:
  - [ ] `project: "https://github.com/orgs/githubnext/projects/122"`
  - [ ] `campaign_id: "security-alert-burndown"` (top-level)
  - [ ] `content_type` ∈ {`issue`, `pull_request`}
  - [ ] `content_number` is an integer
  - [ ] `fields` object is present

### B) Field Validity Checks

- [ ] `fields.status` ∈ {`Todo`, `In Progress`, `Review required`, `Blocked`, `Done`}
- [ ] `fields.campaign_id` is present on first-add/backfill and equals `security-alert-burndown`
- [ ] `fields.worker_workflow` is present on first-add/backfill and is either a known workflow ID or `"unknown"`
- [ ] `fields.repository` matches `owner/repo`
- [ ] `fields.priority` ∈ {`High`, `Medium`, `Low`}
- [ ] `fields.size` ∈ {`Small`, `Medium`, `Large`}
- [ ] `fields.start_date` matches `YYYY-MM-DD`
- [ ] `fields.end_date` matches `YYYY-MM-DD`

### C) Update Semantics Checks

- [ ] For existing items, payload is **status-only** unless explicitly doing a backfill repair.
- [ ] Backfill is used only when required fields are missing/empty/invalid.
- [ ] No payload overwrites `priority`/`size`/`worker_workflow` with defaults during a normal status update.

### D) Read-Write Separation Checks

- [ ] All reads occur before any writes (no read/write interleaving).
- [ ] Writes are batched separately from discovery.

### E) Epic/Hierarchy Checks (Policy-Level)

- [ ] Exactly one Epic exists for the campaign board.
- [ ] Epic is on the board and uses `worker_workflow: "unknown"`.
- [ ] All campaign work issues are sub-issues of the Epic (if supported by environment/tooling).
- [ ] PRs are linked to issues via GitHub linking (e.g. “Closes #123”).

### F) Failure Handling Checks

- [ ] Invalid/deleted/inaccessible items are logged as failures and processing continues.
- [ ] Idempotency is delegated to the `update-project` tool; no pre-filtering by board presence.
---
# CLOSING INSTRUCTIONS (HIGHEST PRIORITY)
---
# Closing Instructions (Highest Priority)

Execute all four steps in strict order:

1. Read State (no writes)
2. Make Decisions (no writes)
3. Write State (update-project only)
4. Report

The following rules are mandatory and override inferred behavior:

- The GitHub Project board is the single source of truth.
- All project writes MUST comply with `project_update_instructions.md`.
- State reads and state writes MUST NOT be interleaved.
- Do NOT infer missing data or invent values.
- Do NOT reorganize hierarchy.
- Do NOT overwrite fields except as explicitly allowed.
- Workers are immutable and campaign-agnostic.

If any instruction conflicts, the Project Update Instructions take precedence for all writes.
